<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ˜“èŠ 1.0</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-blue: #2563eb;
            --main-blue-dark: #1d4ed8;
            --main-bg: #f4f6fb;
            --sidebar-bg: #f1f5f9;
            --bubble-radius: 18px;
            --bubble-padding: 12px 16px;
            --avatar-size: 40px;
            --avatar-size-lg: 56px;
            --transition: cubic-bezier(.4,0,.2,1);
        }
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--main-bg);
            color: #222;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(60,60,120,0.12);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: box-shadow 0.5s var(--transition), border-radius 0.5s var(--transition);
        }
        .topbar {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 0;
            transition: background 0.4s var(--transition);
        }
        .topbar-title {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 2px;
            padding: 18px 0 6px 0;
            transition: color 0.4s var(--transition);
        }
        .topbar-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px 8px 8px;
            gap: 6px;
            flex-wrap: wrap;
            flex-direction: row;
        }
        .topbar-user {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }
        .topbar-btns {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        .topbar-avatar {
            width: var(--avatar-size);
            height: var(--avatar-size);
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
            transition: box-shadow 0.3s var(--transition);
        }
        .topbar-nick {
            font-weight: bold;
            font-size: 16px;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .topbar-friend-select {
            position: relative;
            min-width: 120px;
            max-width: 220px;
            flex: 1;
        }
        .friend-select-btn {
            width: 100%;
            background: #f1f5f9;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            min-width: 0;
            transition: background 0.3s var(--transition), border 0.3s var(--transition);
        }
        .friend-select-list {
            position: absolute;
            left: 0; right: 0; top: 110%;
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0002;
            z-index: 20;
            max-height: 260px;
            overflow-y: auto;
            min-width: 180px;
            animation: fadeInUp 0.35s var(--transition);
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px);}
            to   { opacity: 1; transform: translateY(0);}
        }
        .friend-select-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 10px;
            transition: background 0.15s var(--transition);
        }
        .friend-select-item.selected, .friend-select-item:hover {
            background: #e0e7ff;
        }
        .friend-select-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
        }
        .friend-select-nick {
            font-size: 15px;
            font-weight: 500;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .topbar-addfriend {
            display: flex;
            align-items: center;
            gap: 6px;
            max-width: 180px;
            min-width: 0;
        }
        .topbar-addfriend input {
            flex: 1;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            font-size: 15px;
            transition: border 0.3s var(--transition);
        }
        .topbar-addfriend button {
            padding: 8px 14px;
            border-radius: 12px;
            border: none;
            background: var(--main-blue);
            color: #fff;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s var(--transition);
        }
        .topbar-addfriend button:hover {
            background: var(--main-blue-dark);
        }
        .topbar-logout, .topbar-admin {
            background: var(--main-blue);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 8px 14px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s var(--transition);
            margin-left: 4px;
        }
        .topbar-logout:hover, .topbar-admin:hover {
            background: var(--main-blue-dark);
        }
        .main-content {
            flex: 1;
            display: flex;
            min-height: 0;
            background: #fff;
            padding-bottom: 80px; /* ç•™å‡ºåº•éƒ¨è¾“å…¥æ¡†ç©ºé—´ */
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: #fff;
        }
        .chat-header {
            padding: 18px 32px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 18px;
            font-weight: bold;
            background: #f9fafb;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-header-avatar {
            width: var(--avatar-size);
            height: var(--avatar-size);
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
        }
        .chat-header-nick {
            font-weight: bold;
            font-size: 17px;
        }
        .messages {
            flex: 1;
            padding: 24px 10px 24px 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #fff;
            transition: background 0.3s var(--transition);
        }
        .message-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.4s var(--transition), transform 0.4s var(--transition);
        }
        .message-row.me {
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: var(--avatar-size-lg);
            height: var(--avatar-size-lg);
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
            transition: box-shadow 0.3s var(--transition);
        }
        .message-bubble {
            background: #e0e7ff;
            color: #222;
            border-radius: var(--bubble-radius);
            padding: var(--bubble-padding);
            max-width: 70vw;
            min-width: 40px;
            word-break: break-all;
            font-size: 15px;
            box-shadow: 0 2px 8px #0001;
            transition: background 0.2s var(--transition), color 0.2s var(--transition);
        }
        .message-row.me .message-bubble {
            background: var(--main-blue);
            color: #fff;
        }
        .message .file-link {
            color: var(--main-blue);
            text-decoration: underline;
            font-size: 15px;
        }
        .chat-input-area {
            display: flex;
            align-items: center;
            padding: 16px 18px;
            border-top: 1px solid #e5e7eb;
            gap: 8px;
            background: #f9fafb;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            transition: background 0.3s var(--transition);
            max-width: 900px;
            margin: 0 auto;
        }
        .chat-input-area input[type="text"] {
            flex: 1;
            padding: 10px 14px;
            border-radius: 14px;
            border: 1px solid #d1d5db;
            font-size: 16px;
            transition: border 0.3s var(--transition);
        }
        .chat-input-area input[type="file"] {
            display: none;
        }
        .chat-input-area label {
            background: #e0e7ff;
            color: var(--main-blue);
            padding: 8px 12px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.2s var(--transition);
        }
        .chat-input-area button {
            background: var(--main-blue);
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 10px 18px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s var(--transition);
        }
        .chat-input-area button:hover {
            background: var(--main-blue-dark);
        }
        /* æ¯›ç»ç’ƒå¼¹çª— */
        #settings-modal {
            display: none;
            position: fixed;
            left: 0; top: 0; width: 100vw; height: 100vh;
            z-index: 999;
            background: rgba(0,0,0,0.2);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px) saturate(1.5);
            -webkit-backdrop-filter: blur(8px) saturate(1.5);
            animation: fadeInModal 0.4s var(--transition);
        }
        @keyframes fadeInModal {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        #settings-modal > div {
            background: rgba(255,255,255,0.85);
            border-radius: 18px;
            box-shadow: 0 2px 16px #0001;
            min-width: 300px;
            animation: popIn 0.35s var(--transition);
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.92);}
            to   { opacity: 1; transform: scale(1);}
        }
        #btn-save-profile, #btn-cancel-profile, #btn-upload-avatar, #btn-delete-account {
            background: var(--main-blue);
            color: #fff;
            border: none;
            padding: 8px 18px;
            border-radius: 6px;
            font-weight: bold;
            margin-left: 0;
            margin-right: 8px;
            font-size: 15px;
            transition: background 0.2s var(--transition);
        }
        #btn-save-profile:hover, #btn-cancel-profile:hover, #btn-upload-avatar:hover, #btn-delete-account:hover {
            background: var(--main-blue-dark);
        }
        #btn-delete-account {
            background: #e11d48;
        }
        #btn-delete-account:hover {
            background: #b91c1c;
        }
        /* æ¶ˆæ¯åŠ¨ç”» */
        .message-row.new-anim {
            animation: msgIn 0.45s var(--transition);
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(30px);}
            to   { opacity: 1; transform: translateY(0);}
        }
        @media (max-width: 900px) {
            .container { max-width: 100vw; border-radius: 0; }
            .sidebar { width: 100px; }
            .friend-nick { display: none; }
            .topbar-nick { display: none; }
            .topbar-row { flex-wrap: wrap; gap: 4px; }
            .chat-input-area { max-width: 100vw; }
        }
        @media (max-width: 700px) {
            .container { flex-direction: column; min-height: unset; border-radius: 0; }
            .main-content { flex-direction: column; padding-bottom: 70px; }
            .sidebar { display: none; }
            .friends-list { display: none; }
            .topbar-row, .topbar-row2 { flex-direction: column; align-items: stretch; gap: 6px; }
            .topbar-user { justify-content: flex-start; }
            .topbar-btns { justify-content: flex-end; margin-left: 0; }
            .topbar-addfriend, .topbar-friend-select { max-width: 100vw; }
            .chat-input-area { padding: 10px 6px; position: fixed; left: 0; right: 0; bottom: 0; background: #f9fafb; max-width: 100vw;}
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
const API_BASE = 'http://aiphone.iepose.cn'; // ä¿®æ”¹ä¸ºä½ çš„åç«¯å®é™…åœ°å€

function logout() {
    localStorage.removeItem('currentUser');
    render();
}

function getCurrentUser() {
    return JSON.parse(localStorage.getItem('currentUser') || 'null');
}
function setCurrentUser(user) {
    localStorage.setItem('currentUser', JSON.stringify(user));
}

// å¯†ç å¼ºåº¦æ ¡éªŒ
function checkPassword(pwd) {
    return pwd.length >= 6 &&
        /[a-z]/.test(pwd) &&
        /[A-Z]/.test(pwd) &&
        /\d/.test(pwd);
}

function render() {
    const root = document.getElementById('root');
    const user = getCurrentUser();
    if (!user) {
        renderAuth(root);
    } else if (user.username === 'admincx') {
        renderChat(root, user, true);
    } else {
        renderChat(root, user, false);
    }
}

// ç™»å½•æ³¨å†Œé¡µé¢
function renderAuth(root) {
    root.innerHTML = `
        <div class="container" style="min-height:100vh;">
            <div class="auth">
                <h1 id="auth-title">æ˜“èŠ 1.0</h1>
                <input id="auth-username" placeholder="ç”¨æˆ·å" autocomplete="username"/>
                <input id="auth-password" type="password" placeholder="å¯†ç " autocomplete="current-password"/>
                <button id="auth-btn">ç™»å½•</button>
                <div class="switch-auth" id="switch-auth">æ²¡æœ‰è´¦å·ï¼Ÿæ³¨å†Œ</div>
                <div id="auth-error" style="color:#e11d48;margin-top:10px;"></div>
            </div>
        </div>
    `;
    let isLogin = true;
    document.getElementById('switch-auth').onclick = () => {
        isLogin = !isLogin;
        document.getElementById('auth-title').innerText = 'æ˜“èŠ 1.0';
        document.getElementById('auth-btn').innerText = isLogin ? 'ç™»å½•' : 'æ³¨å†Œ';
        document.getElementById('switch-auth').innerText = isLogin ? 'æ²¡æœ‰è´¦å·ï¼Ÿæ³¨å†Œ' : 'å·²æœ‰è´¦å·ï¼Ÿç™»å½•';
        document.getElementById('auth-error').innerText = '';
    };
    document.getElementById('auth-btn').onclick = async () => {
        const username = document.getElementById('auth-username').value.trim();
        const password = document.getElementById('auth-password').value;
        if (!username || !password) {
            document.getElementById('auth-error').innerText = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
            return;
        }
        if (!isLogin && !checkPassword(password)) {
            document.getElementById('auth-error').innerText = 'å¯†ç ä¸å°‘äº6ä½ï¼Œä¸”åŒ…å«æ•°å­—ã€å¤§å°å†™å­—æ¯';
            return;
        }
        try {
            const res = await fetch(`${API_BASE}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (!data.success) {
                document.getElementById('auth-error').innerText = data.message || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                return;
            }
            setCurrentUser({ username });
            render();
        } catch (e) {
            document.getElementById('auth-error').innerText = 'ç½‘ç»œé”™è¯¯';
        }
    };
}

// èŠå¤©é¡µé¢
function renderChat(root, user, isAdmin) {
    let selectedFriend = localStorage.getItem('selectedFriend') || '';
    let messagesTimer = null;
    let lastMessagesKey = '';
    let lastMessagesData = '';
    let myProfile = {nickname: user.username, avatar: 'https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/user.svg'};
    let friendsCache = [];
    let pendingRequests = [];

    root.innerHTML = `
        <div class="container">
            <div class="topbar">
                <!-- åˆ é™¤ .topbar-title -->
                <div class="topbar-row">
                    <div class="topbar-user">
                        <img id="my-avatar" class="topbar-avatar" src="" alt="å¤´åƒ">
                        <span id="my-nick" class="topbar-user-nick"></span>
                    </div>
                    <div class="topbar-btns">
                        ${isAdmin ? `<button class="topbar-admin" id="btn-admin">åå°ç®¡ç†</button>` : ''}
                        <button class="topbar-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
                    </div>
                </div>
                <div class="topbar-row2">
                    <div class="topbar-friend-select" id="friend-select-wrap"></div>
                    <form class="topbar-addfriend" id="add-friend-form" autocomplete="off" style="margin:0;">
                        <input id="add-friend-input" placeholder="æ·»åŠ å¥½å‹ç”¨æˆ·å" />
                        <button type="submit">æ·»åŠ </button>
                    </form>
                </div>
            </div>
            <div class="main-content">
                <div class="chat-main">
                    <div class="chat-header" id="chat-header"></div>
                    <div class="messages" id="messages"></div>
                    <form class="chat-input-area" id="chat-input-form" autocomplete="off">
                        <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off"/>
                        <input type="file" id="file-input" />
                        <label for="file-input" title="å‘é€æ–‡ä»¶">ğŸ“</label>
                        <button type="submit">å‘é€</button>
                    </form>
                </div>
            </div>
            <div id="settings-modal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:999;background:rgba(0,0,0,0.2);align-items:center;justify-content:center;">
                <div style="background:#fff;padding:32px 24px;border-radius:12px;min-width:300px;box-shadow:0 2px 16px #0001;position:relative;">
                    <h2 style="margin-top:0;">ä¸ªäººè®¾ç½®</h2>
                    <div style="margin-bottom:16px;">
                        <label>å¤´åƒï¼š</label>
                        <input type="file" id="avatar-input" accept="image/*" style="display:none;">
                        <img id="avatar-preview" src="" alt="å¤´åƒ" style="width:64px;height:64px;border-radius:50%;object-fit:cover;background:#eee;vertical-align:middle;"/>
                        <button id="btn-upload-avatar" type="button" style="margin-left:10px;">æ›´æ¢å¤´åƒ</button>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label>æ˜µç§°ï¼š</label>
                        <input id="nick-input" style="padding:6px 10px;border-radius:6px;border:1px solid #ccc;" maxlength="20"/>
                    </div>
                    <div style="text-align:right;">
                        <button id="btn-save-profile" type="button" style="background:#2563eb;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-weight:bold;">ä¿å­˜</button>
                        <button id="btn-cancel-profile" type="button" style="margin-left:10px;">å–æ¶ˆ</button>
                        ${!isAdmin ? `<button id="btn-delete-account" type="button" style="margin-left:10px;background:#e11d48;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-weight:bold;">æ³¨é”€è´¦å·</button>` : ''}
                    </div>
                </div>
            </div>
            <div id="admin-modal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:999;background:rgba(0,0,0,0.2);align-items:center;justify-content:center;">
                <div style="background:#fff;padding:32px 24px;border-radius:12px;min-width:340px;max-width:96vw;box-shadow:0 2px 16px #0001;position:relative;max-height:90vh;overflow:auto;">
                    <h2 style="margin-top:0;">åå°ç®¡ç†</h2>
                    <div id="admin-users-list"></div>
                    <div style="text-align:right;margin-top:18px;">
                        <button id="btn-close-admin" type="button" style="background:#2563eb;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-weight:bold;">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ä¸ªäººä¿¡æ¯åŠ è½½ä¸æ˜¾ç¤º
    async function loadProfile() {
        try {
            const res = await fetch(`${API_BASE}/api/profile?username=${encodeURIComponent(user.username)}`);
            const data = await res.json();
            myProfile = {
                nickname: data.nickname || user.username,
                avatar: data.avatar || 'https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/user.svg'
            };
            document.getElementById('my-avatar').src = myProfile.avatar;
            document.getElementById('my-nick').innerText = myProfile.nickname;
            document.getElementById('avatar-preview').src = myProfile.avatar;
            document.getElementById('nick-input').value = data.nickname || '';
        } catch {
            document.getElementById('my-avatar').src = myProfile.avatar;
            document.getElementById('my-nick').innerText = myProfile.nickname;
            document.getElementById('avatar-preview').src = myProfile.avatar;
            document.getElementById('nick-input').value = '';
        }
    }
    loadProfile();

    // è®¾ç½®å¼¹çª—é€»è¾‘
    document.getElementById('my-avatar').onclick = () => {
        document.getElementById('settings-modal').style.display = 'flex';
    };
    document.getElementById('my-nick').onclick = () => {
        document.getElementById('settings-modal').style.display = 'flex';
    };
    document.getElementById('btn-cancel-profile').onclick = () => {
        document.getElementById('settings-modal').style.display = 'none';
    };
    document.getElementById('btn-upload-avatar').onclick = () => {
        document.getElementById('avatar-input').click();
    };
    document.getElementById('avatar-input').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            document.getElementById('avatar-preview').src = evt.target.result;
        };
        reader.readAsDataURL(file);
    };
    document.getElementById('btn-save-profile').onclick = async () => {
        const nickname = document.getElementById('nick-input').value.trim();
        const avatar = document.getElementById('avatar-preview').src;
        try {
            await fetch(`${API_BASE}/api/profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user.username, nickname, avatar })
            });
            document.getElementById('settings-modal').style.display = 'none';
            loadProfile();
        } catch {
            alert('ä¿å­˜å¤±è´¥');
        }
    };
    // æ³¨é”€è´¦å·
    if (!isAdmin && document.getElementById('btn-delete-account')) {
        document.getElementById('btn-delete-account').onclick = async () => {
            if (!confirm('ç¡®å®šè¦æ³¨é”€è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                await fetch(`${API_BASE}/api/delete-user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user.username })
                });
                logout();
            } catch {
                alert('æ³¨é”€å¤±è´¥');
            }
        };
    }

    // å¥½å‹è¯·æ±‚ç›¸å…³
    async function loadPendingRequests() {
        try {
            const res = await fetch(`${API_BASE}/api/friend-requests?username=${encodeURIComponent(user.username)}`);
            const data = await res.json();
            pendingRequests = data.requests || [];
            renderPendingRequests();
        } catch {}
    }
    function renderPendingRequests() {
        // é¡¶éƒ¨æ·»åŠ ä¸€ä¸ªä¸‹æ‹‰æˆ–å¼¹çª—ï¼Œå±•ç¤ºå¾…å¤„ç†è¯·æ±‚
        let exist = document.getElementById('pending-requests-tip');
        if (pendingRequests.length > 0) {
            if (!exist) {
                const tip = document.createElement('div');
                tip.id = 'pending-requests-tip';
                tip.style = 'position:fixed;top:60px;right:16px;z-index:1000;background:#fff;border-radius:12px;box-shadow:0 2px 8px #0002;padding:12px 18px;';
                tip.innerHTML = `<b>å¥½å‹è¯·æ±‚ï¼š</b><ul style="margin:8px 0 0 0;padding:0;list-style:none;">
                    ${pendingRequests.map(r=>`<li style="margin-bottom:6px;">
                        <span>${r.from}</span>
                        <button data-from="${r.from}" class="btn-accept" style="margin-left:10px;background:#2563eb;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;">åŒæ„</button>
                        <button data-from="${r.from}" class="btn-reject" style="margin-left:4px;background:#e11d48;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;">æ‹’ç»</button>
                    </li>`).join('')}
                </ul>`;
                document.body.appendChild(tip);
                tip.querySelectorAll('.btn-accept').forEach(btn=>{
                    btn.onclick = async ()=>{
                        await fetch(`${API_BASE}/api/accept-friend-request`, {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({username: user.username, from: btn.getAttribute('data-from')})
                        });
                        tip.remove();
                        loadPendingRequests();
                        renderFriendSelect();
                    };
                });
                tip.querySelectorAll('.btn-reject').forEach(btn=>{
                    btn.onclick = async ()=>{
                        await fetch(`${API_BASE}/api/reject-friend-request`, {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({username: user.username, from: btn.getAttribute('data-from')})
                        });
                        tip.remove();
                        loadPendingRequests();
                    };
                });
            }
        } else if (exist) {
            exist.remove();
        }
    }
    loadPendingRequests();

    // å¥½å‹ä¸‹æ‹‰é€‰æ‹©
    async function renderFriendSelect() {
        const wrap = document.getElementById('friend-select-wrap');
        wrap.innerHTML = `<div class="friend-select-btn" id="friend-select-btn"><span>é€‰æ‹©å¥½å‹</span></div>`;
        let friendList = [];
        try {
            const res = await fetch(`${API_BASE}/api/friends?username=${encodeURIComponent(user.username)}`);
            const data = await res.json();
            friendList = data.friends || [];
            friendsCache = friendList;
        } catch { }
        // è·å–æ‰€æœ‰å¥½å‹èµ„æ–™
        const profiles = {};
        for (const f of friendList) {
            profiles[f] = {nickname: f, avatar: 'https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/user.svg'};
            try {
                const res2 = await fetch(`${API_BASE}/api/profile?username=${encodeURIComponent(f)}`);
                const d2 = await res2.json();
                if (d2.nickname) profiles[f].nickname = d2.nickname;
                if (d2.avatar) profiles[f].avatar = d2.avatar;
            } catch {}
        }
        // å½“å‰é€‰ä¸­
        let cur = selectedFriend && friendList.includes(selectedFriend) ? selectedFriend : (friendList[0] || '');
        selectedFriend = cur;
        localStorage.setItem('selectedFriend', selectedFriend || '');
        // æ¸²æŸ“æŒ‰é’®
        wrap.innerHTML = `
            <div class="friend-select-btn" id="friend-select-btn">
                ${cur ? `<img src="${profiles[cur].avatar}" class="friend-select-avatar" alt="å¤´åƒ"><span class="friend-select-nick">${profiles[cur].nickname}</span>` : '<span>é€‰æ‹©å¥½å‹</span>'}
                <span style="margin-left:auto;">â–¼</span>
            </div>
            <div class="friend-select-list" id="friend-select-list" style="display:none;"></div>
        `;
        // æ¸²æŸ“ä¸‹æ‹‰
        const listDiv = wrap.querySelector('#friend-select-list');
        wrap.querySelector('#friend-select-btn').onclick = () => {
            listDiv.style.display = listDiv.style.display === 'block' ? 'none' : 'block';
            if (listDiv.style.display === 'block') {
                listDiv.innerHTML = friendList.length === 0 ? '<div style="padding:12px;color:#888;">æš‚æ— å¥½å‹</div>' :
                    friendList.map(f =>
                        `<div class="friend-select-item${f === selectedFriend ? ' selected' : ''}" data-f="${f}">
                            <img src="${profiles[f].avatar}" class="friend-select-avatar" alt="å¤´åƒ">
                            <span class="friend-select-nick">${profiles[f].nickname}</span>
                        </div>`
                    ).join('');
                // æ»šåŠ¨åˆ°å½“å‰
                setTimeout(() => {
                    const sel = listDiv.querySelector('.selected');
                    if (sel) sel.scrollIntoView({block:'nearest'});
                }, 0);
            }
        };
        listDiv.onclick = e => {
            let target = e.target;
            while (target && !target.classList.contains('friend-select-item')) target = target.parentElement;
            if (target) {
                const f = target.getAttribute('data-f');
                selectedFriend = f;
                localStorage.setItem('selectedFriend', selectedFriend);
                renderFriendSelect();
                renderHeader();
                renderMessages();
                resetMessagesTimer();
            }
            listDiv.style.display = 'none';
        };
        document.body.onclick = e => {
            if (!wrap.contains(e.target)) listDiv.style.display = 'none';
        };
        renderHeader();
        renderMessages();
    }
    renderFriendSelect();

    // å¥½å‹ä¾§è¾¹æ 
    async function renderFriends() {
        const friendsList = document.getElementById('friends-list');
        friendsList.innerHTML = '<div style="color:#888;text-align:center;margin-top:20px;">åŠ è½½ä¸­...</div>';
        try {
            const res = await fetch(`${API_BASE}/api/friends?username=${encodeURIComponent(user.username)}`);
            const data = await res.json();
            friendsList.innerHTML = '';
            if (!data.friends || data.friends.length === 0) {
                friendsList.innerHTML = '<div style="color:#888;text-align:center;margin-top:20px;">æš‚æ— å¥½å‹</div>';
            } else {
                for (const friend of data.friends) {
                    let friendProfile = {nickname: friend, avatar: 'https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/user.svg'};
                    try {
                        const res2 = await fetch(`${API_BASE}/api/profile?username=${encodeURIComponent(friend)}`);
                        const d2 = await res2.json();
                        if (d2.nickname) friendProfile.nickname = d2.nickname;
                        if (d2.avatar) friendProfile.avatar = d2.avatar;
                    } catch {}
                    const div = document.createElement('div');
                    div.className = 'friend' + (friend === selectedFriend ? ' selected' : '');
                    div.innerHTML = `<img src="${friendProfile.avatar}" class="friend-avatar" alt="å¤´åƒ"><span class="friend-nick">${friendProfile.nickname}</span>`;
                    div.onclick = () => {
                        selectedFriend = friend;
                        localStorage.setItem('selectedFriend', friend);
                        renderFriendSelect();
                        renderFriends();
                        renderHeader();
                        renderMessages();
                        resetMessagesTimer();
                    };
                    friendsList.appendChild(div);
                }
            }
        } catch {
            friendsList.innerHTML = '<div style="color:red;text-align:center;margin-top:20px;">åŠ è½½å¤±è´¥</div>';
        }
    }
    renderFriends();

    // æ·»åŠ å¥½å‹
    document.getElementById('add-friend-form').onsubmit = async e => {
        e.preventDefault();
        const friendName = document.getElementById('add-friend-input').value.trim();
        if (!friendName || friendName === user.username) return;
        try {
            const res = await fetch(`${API_BASE}/api/send-friend-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from: user.username, to: friendName })
            });
            const data = await res.json();
            alert(data.message);
        } catch {
            alert('ç½‘ç»œé”™è¯¯');
        }
        document.getElementById('add-friend-input').value = '';
    };

    // èŠå¤©å¤´éƒ¨
    async function renderHeader() {
        if (!selectedFriend) {
            document.getElementById('chat-header').innerText = 'è¯·é€‰æ‹©å¥½å‹';
            return;
        }
        let friendProfile = {nickname: selectedFriend, avatar: 'https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/user.svg'};
        try {
            const res = await fetch(`${API_BASE}/api/profile?username=${encodeURIComponent(selectedFriend)}`);
            const d2 = await res.json();
            if (d2.nickname) friendProfile.nickname = d2.nickname;
            if (d2.avatar) friendProfile.avatar = d2.avatar;
        } catch {}
        document.getElementById('chat-header').innerHTML = `<img src="${friendProfile.avatar}" class="chat-header-avatar" alt="å¤´åƒ"><span class="chat-header-nick">${friendProfile.nickname}</span>`;
    }

    // æ¶ˆæ¯æ¸²æŸ“ï¼ˆdiffä¼˜åŒ–ï¼Œé¿å…é—ªçƒï¼Œå¹³æ»‘æ¨å…¥ï¼‰
    async function renderMessages() {
        if (!selectedFriend) {
            document.getElementById('messages').innerHTML = '';
            return;
        }
        try {
            const res = await fetch(`${API_BASE}/api/messages?user1=${encodeURIComponent(user.username)}&user2=${encodeURIComponent(selectedFriend)}`);
            const data = await res.json();
            const key = user.username + '___' + selectedFriend;
            const dataArr = data.messages || [];
            const dataStr = JSON.stringify(dataArr);
            if (lastMessagesKey === key && lastMessagesData === dataStr) return;
            // å¹³æ»‘æ¨å…¥æ–°æ¶ˆæ¯
            const messagesDiv = document.getElementById('messages');
            // ä»…å¢é‡æ·»åŠ 
            let prevArr = [];
            try { prevArr = JSON.parse(lastMessagesData); } catch {}
            let startIdx = 0;
            while (startIdx < prevArr.length && startIdx < dataArr.length && JSON.stringify(prevArr[startIdx]) === JSON.stringify(dataArr[startIdx])) {
                startIdx++;
            }
            // åªæ·»åŠ æ–°æ¶ˆæ¯
            for (let i = startIdx; i < dataArr.length; i++) {
                const msg = dataArr[i];
                const isMe = msg.from === user.username;
                let avatar = isMe ? myProfile.avatar : 'https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/user.svg';
                let nick = isMe ? myProfile.nickname : msg.from;
                if (!isMe) {
                    try {
                        const res2 = await fetch(`${API_BASE}/api/profile?username=${encodeURIComponent(msg.from)}`);
                        const d2 = await res2.json();
                        if (d2.avatar) avatar = d2.avatar;
                        if (d2.nickname) nick = d2.nickname;
                    } catch {}
                }
                const row = document.createElement('div');
                row.className = 'message-row' + (isMe ? ' me' : '') + ' new-anim';
                row.innerHTML = `
                    <img src="${avatar}" class="message-avatar" alt="å¤´åƒ">
                    <div class="message-bubble">
                        ${
                            msg.type === 'file'
                            ? `<span>ğŸ“ <a class="file-link" href="${msg.content}" download="${msg.filename || msg.fileName}" target="_blank">${msg.filename || msg.fileName}</a></span>`
                            : msg.type === 'image'
                                ? `<span><img src="${msg.content}" alt="å›¾ç‰‡" style="max-width:180px;max-height:120px;border-radius:10px;"></span>`
                                : msg.content
                        }
                    </div>
                `;
                messagesDiv.appendChild(row);
                setTimeout(() => row.classList.remove('new-anim'), 500);
            }
            // åˆ é™¤å¤šä½™æ¶ˆæ¯
            while (messagesDiv.children.length > dataArr.length) {
                messagesDiv.removeChild(messagesDiv.firstChild);
            }
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            lastMessagesKey = key;
            lastMessagesData = dataStr;
        } catch {
            document.getElementById('messages').innerHTML = '<div style="color:red;">æ¶ˆæ¯åŠ è½½å¤±è´¥</div>';
        }
    }

    // å®šæ—¶è½®è¯¢æ¶ˆæ¯
    function resetMessagesTimer() {
        if (messagesTimer) clearInterval(messagesTimer);
        messagesTimer = setInterval(() => {
            renderMessages();
        }, 2000);
    }
    resetMessagesTimer();

    document.getElementById('chat-input-form').onsubmit = async e => {
        e.preventDefault();
        if (!selectedFriend) return;
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;
        try {
            await fetch(`${API_BASE}/api/send-message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    from: user.username,
                    to: selectedFriend,
                    type: 'text',
                    content: text
                })
            });
            input.value = '';
            renderMessages();
        } catch {
            alert('æ¶ˆæ¯å‘é€å¤±è´¥');
        }
    };

    document.getElementById('file-input').onchange = function(e) {
        if (!selectedFriend) return;
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(evt) {
            try {
                let msgType = file.type.startsWith('image/') ? 'image' : 'file';
                await fetch(`${API_BASE}/api/send-message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from: user.username,
                        to: selectedFriend,
                        type: msgType,
                        content: evt.target.result,
                        filename: file.name
                    })
                });
                renderMessages();
            } catch {
                alert('æ–‡ä»¶å‘é€å¤±è´¥');
            }
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    };

    // ç®¡ç†å‘˜åå°ç®¡ç†
    if (isAdmin && document.getElementById('btn-admin')) {
        document.getElementById('btn-admin').onclick = async () => {
            document.getElementById('admin-modal').style.display = 'flex';
            // æ‹‰å–æ‰€æœ‰ç”¨æˆ·
            let users = [];
            try {
                const res = await fetch(`${API_BASE}/api/all-users`);
                users = await res.json();
            } catch {}
            const listDiv = document.getElementById('admin-users-list');
            listDiv.innerHTML = users.length === 0 ? '<div style="color:#888;">æš‚æ— ç”¨æˆ·</div>' :
                users.map(u => `
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                        <img src="${u.avatar || 'https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/user.svg'}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;background:#eee;">
                        <span style="font-weight:bold;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${u.nickname || u.username}</span>
                        <span style="color:#888;font-size:13px;">(${u.username})</span>
                        <button data-uid="${u.username}" class="btn-reset-pwd" style="margin-left:10px;">é‡ç½®å¯†ç </button>
                        <button data-uid="${u.username}" class="btn-edit-profile">æ”¹å¤´åƒæ˜µç§°</button>
                        <button data-uid="${u.username}" class="btn-del-user" style="background:#e11d48;color:#fff;">åˆ é™¤</button>
                    </div>
                `).join('');
            // äº‹ä»¶ç»‘å®š
            listDiv.querySelectorAll('.btn-reset-pwd').forEach(btn => {
                btn.onclick = async () => {
                    const uname = btn.getAttribute('data-uid');
                    const npwd = prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆä¸å°‘äº6ä½ï¼ŒåŒ…å«æ•°å­—ã€å¤§å°å†™å­—æ¯ï¼‰');
                    if (!npwd || !checkPassword(npwd)) return alert('å¯†ç ä¸ç¬¦åˆè¦æ±‚');
                    await fetch(`${API_BASE}/api/admin-reset-password`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({username: uname, password: npwd})
                    });
                    alert('å¯†ç å·²é‡ç½®');
                };
            });
            listDiv.querySelectorAll('.btn-edit-profile').forEach(btn => {
                btn.onclick = async () => {
                    const uname = btn.getAttribute('data-uid');
                    const nnick = prompt('æ–°æ˜µç§°ï¼ˆå¯ç•™ç©ºï¼‰');
                    const file = document.createElement('input');
                    file.type = 'file'; file.accept = 'image/*';
                    file.onchange = async function() {
                        let avatar = '';
                        if (file.files[0]) {
                            const reader = new FileReader();
                            reader.onload = async function(evt) {
                                avatar = evt.target.result;
                                await fetch(`${API_BASE}/api/profile`, {
                                    method: 'POST',
                                    headers: {'Content-Type':'application/json'},
                                    body: JSON.stringify({username: uname, nickname: nnick, avatar})
                                });
                                alert('å·²ä¿®æ”¹');
                            };
                            reader.readAsDataURL(file.files[0]);
                        } else {
                            await fetch(`${API_BASE}/api/profile`, {
                                method: 'POST',
                                headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({username: uname, nickname: nnick})
                            });
                            alert('å·²ä¿®æ”¹');
                        }
                    };
                    file.click();
                };
            });
            listDiv.querySelectorAll('.btn-del-user').forEach(btn => {
                btn.onclick = async () => {
                    const uname = btn.getAttribute('data-uid');
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
                    await fetch(`${API_BASE}/api/delete-user`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({username: uname})
                    });
                    alert('å·²åˆ é™¤');
                    btn.parentElement.remove();
                };
            });
        };
        document.getElementById('btn-close-admin').onclick = () => {
            document.getElementById('admin-modal').style.display = 'none';
        };
    }

    window.onunload = () => {
        if (messagesTimer) clearInterval(messagesTimer);
    };
}

render();
</script>
</body>
</html>